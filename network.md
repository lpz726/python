## 网络层服务
在发送主机和接收主机之间传送段   
基本流程：  
路由->控制平面->算出路由表  
ip协议（在数据平面进行操作）对路由表进行匹配，进行转发   
### 功能
#### 数据平面（局部）
转发：将分组从路由器的输入端口转发到合适的输出端口   
> 传统的转发：基于目标地址+路由表
> SDN方式：基于多个字段+流表

#### 控制平面（全局）
路由：使用路由算法来决定分组从发送主机到目标主机的路径
通过路由选择算法与路径   
### best effort
> IP提供的简单机制能够让互联网被广泛地部署能够包容各种异构网络         
> 如果提供足够的带宽能够，基本就让实时应用（如：交互式音视频）的性能在“大部分时间”内“足够好”            
> 应用层面实现的分布式服务副本（数据中心，内容分发网络）可以让服务更加靠近用户，允许用户从多个位置使用         
> 简单的尽力而为的IP数据报服务，滥用会拥塞，端系统上的“弹性”拥塞控制有助于网络的正常运行
> >- 网络拥塞，主机减少往网络中注入的速率         
> >- 网络轻载，主机加快速率

1. Bandwidth（带宽）：不保证，不承诺为你的数据流预留任何特定的传输速率。你能获得多少带宽完全取决于当时网络的整体拥塞状况。
2. Loss（丢包）：不保证，数据包可能在任何路由器上因队列满而被丢弃，且通常不会通知发送方（除非上层协议如TCP或ICMP反馈）
3. Order（顺序）：不保证，后发送的数据包可能因为选择不同路径而先到达，导致乱序。
4. Timing（时延/抖动）：不保证 ，不保证固定的传输延迟，也不保证延迟的稳定性（抖动）
### router堵塞的原因
1. 当交换机构的输出速率小于输入端口的汇聚速率是，在输入端口会发生堵塞
   > 输出端口竞争即有两个或两以上的数据报（来自不同的输入端口）同时从一个输出端口传出
2. 排在队头的数据报阻止了队列中的其他数据报向前移动
   > 一个数据报在队列头部等待时，造成后面的堵塞
3. 多个输入端口的数据包在同一个时间片内到达同一个输出端口

### [ip format]
<img width="466" height="263" alt="image" src="https://github.com/user-attachments/assets/70d0e91c-efec-4514-b079-80d2ac6fae4e" />

### private ip
在一个本地网络（比如你家或办公室的Wi-Fi网络）中，所有设备（手机、电脑、智能电视等）都会被分配一个属于私有IP地址范围的地址。这些地址是“内部专用”的，只在你的本地网络内有效，不能直接在互联网上被路由和访问。
如果需要访问需要[nat](#NAT)转换机

### 子网   
#### 定义：无需路由器介入，子网内各主机可以在物理上相互直接到达，具有相同的地址前缀         
优势：无需经过中间路由器即可物理到达的目标端口    
IP地址结构：网络位 + 主机位    
子网掩码：用于区分网络位和主机位的32位数字    
1 对应网络位     
0 对应主机位      
CIDR表示法：如 192.168.1.0/24，/24 表示前24位是网络位       
example：  
将 192.168.1.0/24 划分为4个子网      
步骤1：确定需求

> 需要4个子网
> 每个子网主机数 ≤ 62（因为/24有256个地址，4等分）

步骤2：计算需要借用的主机位数

> 需要4个子网：2² = 4 → 需要借用 2位 主机位作为子网位     
> 原网络：192.168.1.0/24（网络位24，主机位8）    
> 新网络：网络位 = 24 + 2 = 26，即 /26    

步骤3：计算新的子网掩码

> 原掩码：255.255.255.0（二进制：11111111.11111111.11111111.00000000）      
> 新掩码：255.255.255.192（二进制：11111111.11111111.11111111.11000000）      
> 最后8位：11000000 = 192     

步骤4：确定每个子网的地址范围
> 借2位 → 有4种组合：00、01、10、11     
> 增量值 = 256 - 192 = 64（每个子网有64个地址）


|子网|	网络地址	|可用主机范围	|广播地址|	CIDR表示|
|----|---|---|----|---|
|子网1	|192.168.1.0|	192.168.1.1 - 192.168.1.62|	192.168.1.63	|192.168.1.0/26
|子网2	|192.168.1.64|	192.168.1.65 - 192.168.1.126|	192.168.1.127|	192.168.1.64/26
|子网3	|192.168.1.128|	192.168.1.129 - 192.168.1.190|	192.168.1.191|	192.168.1.128/26
|子网4	|192.168.1.192	|192.168.1.193 - 192.168.1.254|	192.168.1.255	|192.168.1.192/26

步骤5：验证每个子网的主机数

> 主机位还剩6位（26位网络位，剩下6位主机位）    
> 每个子网可用主机数 = 2⁶ - 2 = 64 - 2 = 62  
>> 减2是因为：网络地址和广播地址不能分配给主机

#### 分类方法
#### CIDR  
无类的ip划分
CIDR 用于将多个连续IP地址块聚合，减少路由表条目。

示例：
将 192.168.0.0/22 划分为4个子网。

原网络：192.168.0.0/22（主机位10位，共1022个可用地址）

需要4个子网，需借用2位（2²=4），新前缀长度为 22+2=24

子网地址：

192.168.0.0/24

192.168.1.0/24

192.168.2.0/24

192.168.3.0/24

每个子网可用主机地址范围（排除网络地址和广播地址）：

192.168.0.1 ~ 192.168.0.254

192.168.1.1 ~ 192.168.1.254

192.168.2.1 ~ 192.168.2.254

192.168.3.1 ~ 192.168.3.254
#### DHCP
**目标**：允许主机在加入网络的时候，动态地从服务器那里获得IP地址：      
可以更新对主机在用IP地址的租用期-租期快到了      
重新启动时，允许重新使用以前用过的IP地址      
支持移动用户加入/退出该网络（短期在网)      
DHCP工作概况:         
•主机广播“DHCP discover”报文[可选]            
•DHCP 服务器用“DHCP offer”提供报文响应[可选]      
•主机请求IP地址：发送“DHCP request”报文      
•DHCP服务器发送地址：“DHCP ack”报文         
**用户请求地址**
> Discover	客户端 → 网络（广播）	客户端大喊：“我是新来的，有DHCP服务器吗？我需要一个IP地址！”   
> Offer	服务器 → 客户端（广播/单播）	DHCP服务器响应：“有！我给你提供一个可用的IP地址（比如192.168.1.100），租给你用一段时间。” （注意：可能有多个服务器响应）    
> Request	客户端 → 网络（广播）	客户端选择一个Offer（通常是第一个收到的），并广播宣布：“我接受这个服务器的Offer，我要用这个IP地址！” 这个广播是为了通知其他服务器收回它们提供的地址。      
> Acknowledgement	服务器 → 客户端（广播/单播）	被选中的服务器最后确认：“成交！这个IP地址正式分配给你了，这是租约和所有配置信息。”
**example**
1. 联网笔记本需要获取自己的IP地址、第一跳路由器地址和DNS服务器：采用DHCP协议            
2. DHCP请求被封装在UDP段中,封装在IP数据报中，封装在以太网的帧中
3. 以太网帧在局域网范围内广播(dest:FFFFFFFFFFFF)，被运行DHCP服务的路由器收到
4. DHCP服务器处：以太网帧解封装成IP，IP解封装成UDP，解封装成DHCP
5. DHCP服务器生成DHCP ACK，包含客户端的IP地址、第一跳路由器的IP地址和DNS域名服务器的IP地址
6. DHCP服务器封装的报文所在的帧转发到客户端，在客户端解封装成DHCP报文         
7. 客户端知道它自己的IP地址、DNS服务器域名和IP地址、第一跳路由器的IP地址

<img width="1124" height="707" alt="image" src="https://github.com/user-attachments/assets/d1d578a7-54f8-4f38-8c42-a25858da2d61" />

#### 层次获取IP的结构

<img width="522" height="325" alt="image" src="https://github.com/user-attachments/assets/c4dcc580-34b4-41a2-85af-d3aaf546fae3" />
<img width="607" height="330" alt="image" src="https://github.com/user-attachments/assets/407e02ed-ba76-46de-8617-f401c1c9a6ad" />



#### NAT
作用：使整个本地网络只有一个有效的ip地址
怎么实现：
1. 处理出站数据包（替换源地址）
  > 动作：当本地网络内的设备（如IP 10.0.0.1，端口 3345）发送数据包到互联网时，NAT路由器会拦截这个数据包。
  > 替换：将数据包头的 （源IP地址，源端口号） 替换为 （NAT路由器的公网IP地址，一个唯一的新端口号）。
  > 例如：(10.0.0.1:3345) → (138.76.29.7:5001)
  > 目的：互联网上的服务器只会看到数据包来自 138.76.29.7:5001，而不知道内部真实的 10.0.0.1。


2. 维护NAT转换表（记忆映射关系）NAT路由器必须立即将这一转换关系记录在一个 NAT转换表中   
3. 处理入站数据包（恢复目的地址）
  > 当互联网上的服务器回复数据包（目的地址为 138.76.29.7:5001）时，NAT路由器收到此包。
> 查找与替换：
>> 检查数据包的 （目的IP地址，目的端口号），即 (138.76.29.7:5001)。   
>> 在NAT转换表中查找匹配项。
>> 将数据包头的 （目的IP地址，目的端口号） 替换为表中对应的 （内部源IP地址，源端口号），即 (10.0.0.1:3345)。
   
识别NAT类型：   
R2上的规则是DNAT（目的地址转换），将外部对公网IP的访问转发到内部Web服务器。   
R3上的规则是SNAT（源地址转换），将内部私有地址转换为公网地址。   
分析数据包地址变化：   
H2发送时：源IP（H2私有地址），目的IP（Web服务器的公网地址或R2的公网地址）。   
经过R3（SNAT）：源IP变为R3的公网地址。   
经过R2（DNAT）：目的IP变为Web服务器的私有地址。   
NAT表配置：   
R2需要配置一条DNAT规则：将到达特定公网IP和端口（如80）的请求转发到内部Web服务器。   

#### middle box
定义：在源主机到目标主机的数据传输路径上，任何一个中间设备如果执行了IP路由器正常、标准功能之外的任何设备，就叫做中间盒      
作用：在源主机和目的主机之间的数据路径上，执行除标准IP路由器正常功能之外的任何功能的中间设备。      

#### link state     
1. 发现相邻节点，获知对方网络地址            
2. 测量到相邻节点的代价 (延迟，开销)               
3. 组装一个LS分组，描述它到相邻节点的代价情况            
4. 将分组通过扩散的方法发到所有其它路由器                  
以上4步让每个路由器获得拓扑和边代价            
5. 通过Dijkstra算法算出最短路径（这才是路由算法）            
a)每个节点独立算出来到其他节点的最短路径            
b)迭代算法：每个节点第k步能够知道本节点到k个其他节点的最短路径
时间复杂度:n节点               
每个n的迭代：都需要检测所有不在N’中的w节点         
n(n+1)/2比较: O(n2) 复杂度         
可能存在更加高效的实现：O(nlogn）         
[example](https://chat.deepseek.com/share/d1lyzpqwl5k0ydvyla)
消息复杂度：LS: n个路由器, O(n2) 消息发送            

#### DV

<img width="1019" height="565" alt="image" src="https://github.com/user-attachments/assets/43b9a916-5d4d-4d97-9d68-785ecf2325f8" />


### 算法对比      

<img width="1137" height="637" alt="image" src="https://github.com/user-attachments/assets/f51eb680-334c-47a7-b18b-7da61e96fd61" />


#### 震荡
路由震荡是指网络中的路由信息无法收敛到一个稳定状态，而是不同路由器之间关于最优路径的选择周期性、反复地变化，导致流量在几条路径之间来回切换，网络处于持续的不稳定状态   
核心原因：当链路代价（如延迟、丢包率）动态依赖于当前流经该链路的流量时，就会形成一个反馈循环，可能引发震荡。   
#### good bad news
DV算法中[原理以及操作](https://chat.deepseek.com/share/sqrt3yhafhv5gujvks)   

### OSPF
在as里面泛洪，不会往外溢出，控制泛洪范围（原理是LS算法在区域内的分发，路由计算使用Dijkstra算法）
### BGP
eBGP：从相邻ases中获得子网可达信息    
iBGP：将获得的子网可达信息传遍到as内部的所有路由器中

### ICMP
ping 命令： 使用的是 ICMP回显请求 和 ICMP回显应答 消息。   
你ping www.google.com时， 你的电脑会发送一个 ICMP Echo Request 到目标。   
如果目标可达且允许响应，它会返回一个 ICMP Echo Reply。   
通过计算往返时间，你可以判断网络的连通性和延迟。   

traceroute / tracert 命令： 巧妙地利用ICMP的 超时 和 目的地不可达 消息来追踪数据包到达目标所经过的路径。   
它发送一系列TTL值递增的数据包。   
路径上的每个路由器在TTL减至0时，都会发回一个ICMP超时消息，从而暴露自己的地址。   
最终到达目标时，目标会返回一个“端口不可达”消息（通常是UDP探测）或“回显应答”（ICMP探测），完成路径追踪。  

### 奇偶校验和网络校验
[详情](https://chat.deepseek.com/share/ycuiai3l2sesihrw8i)   

### CRC

生成多项式最高位为多少，就在数据后面补几个零，然后进行模二除法（相同取0，不同取1）得余数
如何用CRC 校验码验证传输过程有无差错产生？    
发送端将数据与CRC校验码拼接发送。接收端将接收到的数据除以同样的生成多项式（模2除法）。若余数为0，则认为传输无差错；否则有差错。 



### ALOHA
假定  4  个活跃结点  A、B、C、D  都使用时隙  ALOHA  来竞争某信道，且每个结点有无
限个分组需要发送，每个结点在每个时隙中以概率  𝑝  尝试传输；假定  𝑝  为已知常量。第
一个时隙编号为时隙  1，第二个时隙编号为时隙  2.··以此类推(请给出少量文字说明分析过
程)    
(1)  结点  A 的第一次成功传输发生在第4 个时隙的概率是多少?     
(2)  某个结点  (A、B、C 或D 任一结点成功均可)在时隙  3  中成功的概率是多少?     
(3)  首次成功传发生在时隙  4  的概率是多少?（即，此前三个时隙没有任何节点成功传输）    
(4)  这个  4  结点系统的效率是多少?以“分组每时隙”为单位回答。    
  

(1) 结点A第一次成功发生在时隙4的概率   
单个时隙A成功的概率：$q=p(1-p)^3$    
前三个时隙A均不成功的概率：$(1-q)^3$      
所求概率: $(1-p(1-p)^3)^3*p(1-p)^3$     

(2) 某个结点在时隙3成功的概率                  
恰好一个节点发送的概率: $4p(1-p)^3$      

(3) 首次成功发生在时隙4的概率    
单个时隙无任何节点成功的概率：$1-4p(1-p)^3$   
前三个时隙均无成功的概率：$(1-4p(1-p)^3)^3$   
时隙4成功的概率：$4p(1-p)^3$     
所求概率：$(1-4p(1-p)^3)^3*4p(1-p)^3$       

(4) 系统效率     
效率 = 平均每时隙成功传输分组数 = $4p(1-p)^3$(分组/时隙)

#### CSMA
CD是冲突处理
> 冲突检测：节点在发送数据的同时，持续侦听信道。   
> 判断冲突：通过比较发送的信号与侦听到的信号，如果发现不一致（例如，侦听到的信号强度异常高），则判定发生了冲突。   
> 立即中止：一旦检测到冲突，节点立即停止发送当前帧。这大大缩短了信道被无效占用的时间。      
> 发送阻塞信号：停止发送后，节点会发送一个短暂的阻塞信号，以确保所有节点都能感知到这次冲突。   
> 随机退避：节点等待一段随机时间后，重新尝试发送（使用二进制指数退避算法）。   

CSMA/CD 在有线局域网中容易实现

|协议	|全称|	中文名|	核心原理|	典型应用|	优点|	缺点|
|---|---|---|---|----|----|---|
|FDMA|	Frequency Division Multiple Access	|频分多址	|按频率划分：每个用户分配独占的频带	|1G蜂窝网、有线电视、无线电广播|	无冲突；简单|	频带利用率低；不适用于突发流量|
|TDMA	|Time Division Multiple Access|	时分多址	|按时隙划分：每个用户在固定时隙内独占整个频带|	2G（GSM）、TDM网络	|无冲突；适于数字信号|	需要时间同步；时隙可能空闲|
|CDMA	|Code Division Multiple Access	|码分多址	|按编码划分：所有用户同时同频传输，用正交码区分	|3G（CDMA2000）、军事通信	|抗干扰强；容量柔性；软切换	|功率控制要求高；远近效应|
|ALOHA|	—	—|--	|纯随机发送：有数据就发，冲突则随机退避后重发	|早期卫星通信、RFID	|极其简单；完全分布式	|吞吐量极低（最高18.4%）|
|Slotted ALOHA	|—|	时隙ALOHA	|在同步时隙起点发送，减少冲突窗口|	卫星通信、某些无线网络|	比纯ALOHA效率高（最高36.8%）|	需要时间同步；仍有冲突
|CSMA|	Carrier Sense Multiple Access|	载波侦听多路访问|	先听后说：发送前侦听信道，空闲则发送	|早期以太网、某些局域网	|减少冲突；简单	|仍有冲突可能（传播延迟导致）
|CSMA/CD|	CSMA with Collision Detection|	带冲突检测的CSMA|	边听边说：发送同时检测冲突，冲突则立即停止并发送阻塞信号	|传统有线以太网（10BASE5/2）|	快速冲突解决；提高利用率|	不适用于无线（隐藏终端、信号衰减）
|CSMA/CA	|CSMA with Collision Avoidance	|带冲突避免的CSMA	|先听后说+随机退避：空闲后等待一个随机时间再发送；|有时用RTS/CTS预约	Wi-Fi（IEEE 802.11）	|适应无线环境；避免隐蔽终端问题	|开销较大；效率低于CSMA/CD|

### MAC
MAC地址是一个固化在网卡硬件中的、全球唯一的48位标识符。地址划分是网络设备一开始就划分好的
####  [docsis怎么work，binary exponential backoff怎么work,什么是switch selflearning怎么work switch和router区别 ](https://chat.deepseek.com/share/ia1wawl72v3mdo5fzn)
### 交换机自学习
通过网卡确定host端口位置（不是一直保存），如果收到帧不知道向哪个端口发，那么就转向所有端口转发（同一个端口进的不可以从同一端口出）

### [cdma码分多址常考,csmaca,rts cts,802frame中三个地址是干什么的,蓝牙信道怎么划分](https://chat.deepseek.com/share/80hyoauuhyl9giql6r)




