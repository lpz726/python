## 指令系统
核心步骤：CPU 从内存取指令 → 译码 → 取操作数 → 执行 → 存结果 → 更新PC（程序计数器）→ 循环        
CISC指令风格：变长操作码 / 变长指令字 / 指令多 / 寻址方式多 / 指令格式多           
RISC指令风格：指令少 / 寻址方式少 / 指令格式少 / 指令长度一致        
#### R型指令（例如：add, sub, and, or, slt等）    
格式：opcode+rd+rs1+rs2+funct      无立即数      
功能：R[rd] = R[rs1] op R[rs2]     
数据通路  ： 
- 从指令中提取rs1和rs2，从寄存器文件中读取两个操作数。    
- 将这两个操作数送入ALU。      
- ALU根据funct3和funct7（对于R型指令，ALU控制信号由funct3和funct7共同决定，例如add和sub通过funct7区分）执行相应操作。      
- ALU的结果在时钟周期结束时写回寄存器文件的rd端口。    
GPR：busA ← R[rs1], busB ← R[rs2]。        
ALUSrc = 0 -> ALU 输入 B = busB。 ALUOp 由 funct/ALUctrl 决定（如 ADD/SUB/AND 等）。        
ALU 计算 Result = busA op busB，输出暂存 ALUOut。        
RegWrite=1, MemtoReg=0, RegDst selects rd，busW ← ALUOut，把结果写回 R[rd]。            
PC ← PC + 4（或 PC+1），常在 IF 阶段更新（单周期或多周期均如此）。        

#### I型指令（算术逻辑运算，例如addi, andi, ori等）   
功能：R[rd] = R[rs1] op imm（立即数符号扩展后）   
数据通路：  
从指令中提取rs1，从寄存器文件中读取一个操作数。      
- 立即数扩展器将12位立即数符号扩展为32位。
- 并且经过多路选择器MUX    
- ALU的两个输入分别为寄存器读出的数据和扩展后的立即数。      
- ALU根据funct3执行相应操作（I型指令的funct7字段无效，因为I型指令的立即数只有12位，funct7部分被用于立即数编码）。      
- 结果写回寄存器文件的rd端口。
ID: A ← R[rs1]. ImmExt ← EXT(imm).      
EX: ALUSrc = 1 -> ALU B = ImmExt. ALUOp set to ADD/ORI/SLTI per opcode/funct3.      
ALU → ALUOut.      
WB: R[rd] ← ALUOut (RegWrite=1, MemtoReg=0).      
PC updates normal (PC+4) except for jalr where PC ← ALUOut possibly.
#### U型指令（例如lui, auipc）
功能：    
- lui: R[rd] = imm << 12（将20位立即数左移12位，低12位补0）      
- auipc: R[rd] = PC + (imm << 12)      
数据通路：
- 立即数扩展器将20位立即数（位于指令的31:12）左移12位（低12位补0）形成32位立即数。      
- 对于lui，这个立即数直接作为结果写回寄存器。      
- 对于auipc，需要将PC与该立即数相加，结果写回寄存器。
LUI: R[rd] ← imm << 12      
ID: ImmU ← IR.imm << 12      
WB: R[rd] ← ImmU (RegWrite=1, MemtoReg=0, ALU not used)      
AUIPC: R[rd] ← PC + (imm << 12)      
EX: ALUOut ← PC + ImmU        
WB: R[rd] ← ALUOut.          
#### L型指令（Load指令，例如lw, lh, lb等）    
功能：R[rd] = M[R[rs1] + imm]（从内存中读取一个数据，地址为R[rs1]加上符号扩展的立即数）      
数据通路：      
- 从寄存器文件读取rs1的值。      
- 立即数扩展器将12位立即数符号扩展为32位。        
- ALU执行加法，计算内存地址：地址 = R[rs1] + imm。        
- 数据存储器（DM）根据该地址读取数据。        
- 读取的数据写回寄存器文件的rd端口。
ID: A ← R[rs1], ImmExt←EXT(imm).        
EX: ALU computes address ALUOut ← A + ImmExt (ALUSrc=1, ALUOp=ADD).        
MEM: MDR ← Mem[ ALUOut ] (MemRead=1).        
WB: R[rd] ← MDR (MemtoReg=1, RegWrite=1).
关键连接：DataMem 的 Adr 接 ALUOut；DataMem 的 DataOut 接 MDR；MDR 接 MemtoReg MUX；MemtoReg=1 选择 MDR 写回寄存器。    
#### S型指令（Store指令，例如sw, sh, sb等）
功能：M[R[rs1] + imm] = R[rs2]      
数据通路：    
- 从寄存器文件读取rs1和rs2的值。    
- 立即数扩展器将12位立即数（注意S型指令的立即数由两部分组成）符号扩展为32位。      
- ALU执行加法，计算内存地址：地址 = R[rs1] + imm。    
- 将寄存器rs2的值写入数据存储器的该地址。
ID: A ← R[rs1] (base), B ← R[rs2] (store value), ImmExt.      
EX: ALUOut ← A + ImmExt.        
MEM: Mem[ALUOut] ← B (MemWrite=1). 也可能先写入 MDR then memory.        
WB: no register write.
关键连接：DataMem's DataIn must come from B (busB) or MDR with appropriate byte-enable. Address from ALUOut.        
#### B型指令（条件分支指令，例如beq, bne, blt等）
功能：if (R[rs1] op R[rs2]) then PC = PC + imm，否则PC = PC+4        
数据通路：  
- 从寄存器文件读取rs1和rs2的值。          
- 立即数扩展器将13位立即数（B型立即数由两部分组成，实际是13位，因为最低位为0，所以是12位立即数左移1位？注意：在RISC-V中，B型立
  即数是12位，但需要左移1位，所以是13位符号扩展，然后左移1位？实际上，B型立即数在指令中编码为12位，但形成32位立即数时
  需要将最低位置0，所以相当于13位立即数（符号扩展后）左移1位。但在单周期数据通路中，我们通常先扩展然后左移1位（或者直
  接扩展为32位，然后左移1位，但注意左移1位相当于乘以2）。          
- 同时，我们需要计算两个地址：PC+4 和 PC+imm（imm左移1位后符号扩展为32位，然后与PC相加）。      
- ALU对两个寄存器值进行比较（通过减法等，根据funct3决定比较类型），产生比较结果（如Zero标志，或者有符号比较结果等）。      
- 根据比较结果，通过一个多路选择器选择下一个PC的值：要么是PC+4，要么是PC+imm。      
ID: A ← R[rs1]; B ← R[rs2]; ImmExt.        
EX: ALU computes A - B (ALUOp=SUB) to generate Zero flag OR comparator 
unit checks equality; branch target ALUOut ← PC + ImmExt (or dedicated adder does PC+imm).    
If Zero && Branch → PC ← ALUOut (PCWrite with PCSrc select branch target). Else PC remains PC+4.    
Two typical implementations:          
Single ALU: Do A-B and branch target compute PC+Imm via same ALU in separate cycle or adder.      
Dedicated adder: dedicated PC + Imm adder produces branch target in same cycle; ALU just computes comparator.        
#### J型指令（无条件跳转，例如jal）
功能：R[rd] = PC+4; PC = PC + imm（imm是20位立即数，左移1位后符号扩展）    
数据通路：      
- 立即数扩展器将20位立即数（J型立即数编码类似B型，但更长）左移1位（因为跳转目标地址是2字节对齐的）
- 并符号扩展为32位，然后与PC相加得到跳转目标地址。      
- 同时，计算PC+4（下一条指令地址）。            
- 将PC+4写入寄存器文件的rd端口（作为返回地址）。        
- 将跳转目标地址写入PC。      
ID: compute ImmExt (target offset)      
EX: compute target = PC + ImmExt (ALU)      
WB: R[rd] ← PC + 4 (if link register required) (RegWrite=1, MemtoReg selects PC+4)      
PC update: PC ← target (PCWrite=1, PCSrc selects ALUOut)      
Note: The write-back of PC+4 must happen (store return address), so MemtoReg mux must be able to select PC+4.      
























 
